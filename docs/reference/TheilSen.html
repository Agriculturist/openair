<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Tests for trends using Theil-Sen estimates — TheilSen â€¢ openair</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>

<!-- mathjax -->
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">openair</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/davidcarslaw/openair">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Tests for trends using Theil-Sen estimates</h1>
    </div>

    
    <p>Theil-Sen slope estimates and tests for trend.</p>
    

    <pre><span class='fu'>TheilSen</span>(<span class='no'>mydata</span>, <span class='kw'>pollutant</span> <span class='kw'>=</span> <span class='st'>"nox"</span>, <span class='kw'>deseason</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>type</span> <span class='kw'>=</span> <span class='st'>"default"</span>,
  <span class='kw'>avg.time</span> <span class='kw'>=</span> <span class='st'>"month"</span>, <span class='kw'>statistic</span> <span class='kw'>=</span> <span class='st'>"mean"</span>, <span class='kw'>percentile</span> <span class='kw'>=</span> <span class='fl'>NA</span>,
  <span class='kw'>data.thresh</span> <span class='kw'>=</span> <span class='fl'>0</span>, <span class='kw'>alpha</span> <span class='kw'>=</span> <span class='fl'>0.05</span>, <span class='kw'>dec.place</span> <span class='kw'>=</span> <span class='fl'>2</span>, <span class='kw'>xlab</span> <span class='kw'>=</span> <span class='st'>"year"</span>,
  <span class='kw'>lab.frac</span> <span class='kw'>=</span> <span class='fl'>0.99</span>, <span class='kw'>lab.cex</span> <span class='kw'>=</span> <span class='fl'>0.8</span>, <span class='kw'>x.relation</span> <span class='kw'>=</span> <span class='st'>"same"</span>,
  <span class='kw'>y.relation</span> <span class='kw'>=</span> <span class='st'>"same"</span>, <span class='kw'>data.col</span> <span class='kw'>=</span> <span class='st'>"cornflowerblue"</span>, <span class='kw'>trend</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>lty</span> <span class='kw'>=</span>
  <span class='fu'>c</span>(<span class='fl'>1</span>, <span class='fl'>5</span>), <span class='kw'>lwd</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>2</span>, <span class='fl'>1</span>), <span class='kw'>col</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='st'>"red"</span>, <span class='st'>"red"</span>)), <span class='kw'>text.col</span> <span class='kw'>=</span> <span class='st'>"darkgreen"</span>,
  <span class='kw'>slope.text</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>cols</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>shade</span> <span class='kw'>=</span> <span class='st'>"grey95"</span>, <span class='kw'>auto.text</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>autocor</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>slope.percent</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>date.breaks</span> <span class='kw'>=</span> <span class='fl'>7</span>, <span class='no'>...</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <dl class="dl-horizontal">
      <dt>mydata</dt>
      <dd>A data frame containing the field <code>date</code> and at
least one other parameter for which a trend test is required;
typically (but not necessarily) a pollutant.</dd>
      <dt>pollutant</dt>
      <dd>The parameter for which a trend test is required.
Mandatory.</dd>
      <dt>deseason</dt>
      <dd>Should the data be de-deasonalized first? If 
<code>TRUE</code> the function <code>stl</code> is used (seasonal trend 
decomposition using loess). Note that if <code>TRUE</code> missing
data are first linearly interpolated because <code>stl</code> cannot
handle missing data.</dd>
      <dt>type</dt>
      <dd><code>type</code> determines how the data are split i.e.
conditioned, and then plotted. The default is will produce a 
single plot using the entire data. Type can be one of the
built-in types as detailed in <code>cutData</code> e.g.
&#8220;season&#8221;, &#8220;year&#8221;, &#8220;weekday&#8221; and so on. For
example, <code>type = &quot;season&quot;</code> will produce four plots --- one
for each season.

It is also possible to choose <code>type</code> as another variable in
the data frame. If that variable is numeric, then the data will
be split into four quantiles (if possible) and labelled 
accordingly. If type is an existing character or factor
variable, then those categories/levels will be used directly.
This offers great flexibility for understanding the variation of
different variables and how they depend on one another.

Type can be up length two e.g. <code>type = c(&quot;season&quot;, 
&quot;weekday&quot;)</code> will produce a 2x2 plot split by season and day of
the week. Note, when two types are provided the first forms the 
columns and the second the rows.</dd>
      <dt>avg.time</dt>
      <dd>Can be &#8220;month&#8221; (the default), 
&#8220;season&#8221; or &#8220;year&#8221;. Determines the time over which
data should be averaged. Note that for &#8220;year&#8221;, six or
more years are required. For &#8220;season&#8221; the data are split
up into spring: March, April, May etc. Note that December is
considered as belonging to winter of the following year.</dd>
      <dt>statistic</dt>
      <dd>Statistic used for calculating monthly values.
Default is &#8220;mean&#8221;, but can also be &#8220;percentile&#8221;.
See <code>timeAverage</code> for more details.</dd>
      <dt>percentile</dt>
      <dd>Single percentile value to use if 
<code>statistic = &quot;percentile&quot;</code> is chosen.</dd>
      <dt>data.thresh</dt>
      <dd>The data capture threshold to use (<!-- %) when  -->
aggregating the data using <code>avg.time</code>. A value of zero
means that all available data will be used in a particular
period regardless if of the number of values available.
Conversely, a value of 100 will mean that all data will need to
be present for the average to be calculated, else it is recorded
as <code>NA</code>.</dd>
      <dt>alpha</dt>
      <dd>For the confidence interval calculations of the
slope. The default is 0.05. To show 99% confidence intervals
for the value of the trend, choose alpha = 0.01 etc.</dd>
      <dt>dec.place</dt>
      <dd>The number of decimal places to display the trend
estimate at. The default is 2.</dd>
      <dt>xlab</dt>
      <dd>x-axis label, by default <code>&quot;year&quot;</code>.</dd>
      <dt>lab.frac</dt>
      <dd>Fraction along the y-axis that the trend
information should be printed at, default 0.99.</dd>
      <dt>lab.cex</dt>
      <dd>Size of text for trend information.</dd>
      <dt>x.relation</dt>
      <dd>This determines how the x-axis scale is plotted.
&#8220;same&#8221; ensures all panels use the same scale and 
&#8220;free&#8221; will use panel-specfic scales. The latter is a 
useful setting when plotting data with very different values.</dd>
      <dt>y.relation</dt>
      <dd>This determines how the y-axis scale is plotted.
&#8220;same&#8221; ensures all panels use the same scale and 
&#8220;free&#8221; will use panel-specfic scales. The latter is a 
useful setting when plotting data with very different values.</dd>
      <dt>data.col</dt>
      <dd>Colour name for the data</dd>
      <dt>trend</dt>
      <dd>list containing information on the line width, line 
type and line colour for the main trend line and confidence 
intervals respectively.</dd>
      <dt>text.col</dt>
      <dd>Colour name for the slope/uncertainty numeric
estimates</dd>
      <dt>slope.text</dt>
      <dd>The text shown for the slope (default is
&#8216;units/year&#8217;).</dd>
      <dt>cols</dt>
      <dd>Predefined colour scheme, currently only enabled for 
<code>&quot;greyscale&quot;</code>.</dd>
      <dt>shade</dt>
      <dd>The colour used for marking alternate years. Use 
&#8220;white&#8221; or &#8220;transparent&#8221; to remove shading.</dd>
      <dt>auto.text</dt>
      <dd>Either <code>TRUE</code> (default) or <code>FALSE</code>. If 
<code>TRUE</code> titles and axis labels will automatically try and
format pollutant names and units properly e.g.  by subscripting
the &#8216;2&#8217; in NO2.</dd>
      <dt>autocor</dt>
      <dd>Should autocorrelation be considered in the trend 
uncertainty estimates? The default is <code>FALSE</code>. Generally,
accounting for autocorrelation increases the uncertainty of the
trend estimate --- sometimes by a large amount.</dd>
      <dt>slope.percent</dt>
      <dd>Should the slope and the slope uncertainties 
be expressed as a percentage change per year? The default is 
<code>FALSE</code> and the slope is expressed as an average units/year
change e.g. ppb.  Percentage changes can often be confusing and 
should be clearly defined.  Here the percentage change is 
expressed as 100 * (C.end/C.start - 1) / (end.year - 
start.year). Where C.start is the concentration at the start 
date and C.end is the concentration at the end date.

For <code>avg.time = &quot;year&quot;</code> (end.year - start.year) will be the
total number of years - 1. For example, given a concentration in
year 1 of 100 units and a percentage reduction of 5<!-- %/yr, after 5 -->
years there will be 75 units but the actual time span will be 6 
years i.e. year 1 is used as a reference year. Things are
slightly different for monthly values e.g.  <code>avg.time =
&quot;month&quot;</code>, which will use the total number of months as a basis
of the time span and is therefore able to deal with partial
years.  There can be slight differences in the <!-- %/yr trend -->
estimate therefore, depending on whether monthly or annual
values are considered.</dd>
      <dt>date.breaks</dt>
      <dd>Number of major x-axis intervals to use. The 
function will try and choose a sensible number of dates/times as
well as formatting the date/time appropriately to the range 
being considered. This does not always work as desired
automatically. The user can therefore increase or decrease the
number of intervals by adjusting the value of <code>date.breaks</code>
up or down.</dd>
      <dt>...</dt>
      <dd>Other graphical parameters passed onto <code>cutData</code>
and <code>lattice:xyplot</code>. For example, <code>TheilSen</code> passes
the option <code>hemisphere = &quot;southern&quot;</code> on to <code>cutData</code>
to provide southern (rather than default northern) hemisphere
handling of <code>type = &quot;season&quot;</code>. Similarly, common axis and
title labelling options (such as <code>xlab</code>, <code>ylab</code>,
<code>main</code>) are passed to <code>xyplot</code> via <code>quickText</code> to
handle routine formatting.</dd>
    </dl>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>As well as generating the plot itself, <code>TheilSen</code>
  also returns an object of class ``openair&#39;&#39;. The object includes
  three main components: <code>call</code>, the command used to generate
  the plot; <code>data</code>, the data frame of summarised information
  used to make the plot; and <code>plot</code>, the plot itself. If
  retained, e.g. using <code>output &lt;- TheilSen(mydata, &quot;nox&quot;)</code>,
  this output can be used to recover the data, reproduce or rework
  the original plot or undertake further analysis.</p>
    <p>An openair output can be manipulated using a number of generic
  operations, including <code>print</code>, <code>plot</code> and
  <code>summary</code>.</p>
    <p>The <code>data</code> component of the <code>TheilSen</code> output includes
  two subsets: <code>main.data</code>, the monthly data <code>res2</code> the
  trend statistics. For <code>output &lt;- TheilSen(mydata, &quot;nox&quot;)</code>,
  these can be extracted as <code>object$data$main.data</code> and
  <code>object$data$res2</code>, respectively.</p>
    <p>Note: In the case of the intercept, it is assumed the y-axis crosses the
  x-axis on 1/1/1970.</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The <code>TheilSen</code> function provides a collection of functions to
analyse trends in air pollution data. The <code>TheilSen</code> function
is flexible in the sense that it can be applied to data in many
ways e.g. by day of the week, hour of day and wind direction. This
flexibility makes it much easier to draw inferences from data
e.g. why is there a strong downward trend in concentration from
one wind sector and not another, or why trends on one day of the
week or a certain time of day are unexpected.</p>
    <p>For data that are strongly seasonal, perhaps from a background
site, or a pollutant such as ozone, it will be important to
deseasonalise the data (using the option <code>deseason =
TRUE</code>.Similarly, for data that increase, then decrease, or show
sharp changes it may be better to use <code><a href='smoothTrend.html'>smoothTrend</a></code>.</p>
    <p>A minimum of 6 points are required for trend estimates to be made.</p>
    <p>Note! that since version 0.5-11 openair uses Theil-Sen to derive
the p values also for the slope. This is to ensure there is
consistency between the calculated p value and other trend
parameters i.e. slope estimates and uncertainties. The p value and
all uncertainties are calculated through bootstrap simulations.</p>
    <p>Note that the symbols shown next to each trend estimate relate to
how statistically significant the trend estimate is: p $&lt;$ 0.001 =
***, p $&lt;$ 0.01 = **, p $&lt;$ 0.05 = * and p $&lt;$ 0.1 = $+$.</p>
    <p>Some of the code used in <code>TheilSen</code> is based on that from
Rand Wilcox <a href = 'http://www-rcf.usc.edu/~rwilcox/'>http://www-rcf.usc.edu/~rwilcox/</a>. This mostly
relates to the Theil-Sen slope estimates and uncertainties.
Further modifications have been made to take account of correlated
data based on Kunsch (1989). The basic function has been adapted
to take account of auto-correlated data using block bootstrap
simulations if <code>autocor = TRUE</code> (Kunsch, 1989). We follow the
suggestion of Kunsch (1989) of setting the block length to n(1/3)
where n is the length of the time series.</p>
    <p>The slope estimate and confidence intervals in the slope are plotted and
numerical information presented.</p>
    
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Helsel, D., Hirsch, R., 2002. Statistical methods in water resources. US
  Geological Survey.  <a href = 'http://pubs.usgs.gov/twri/twri4a3/'>http://pubs.usgs.gov/twri/twri4a3/</a>. Note that
  this is a very good resource for statistics as applied to environmental
  data.</p>
    <p>Hirsch, R. M., Slack, J. R., Smith, R. A., 1982. Techniques of trend
  analysis for monthly water-quality data. Water Resources Research 18 (1),
  107-121.</p>
    <p>Kunsch, H. R., 1989. The jackknife and the bootstrap for general stationary
  observations. Annals of Statistics 17 (3), 1217-1241.</p>
    <p>Sen, P. K., 1968. Estimates of regression coefficient based on
Kendall&#39;s tau. Journal of the American Statistical Association
63(324).</p>
    <p>Theil, H., 1950. A rank invariant method of linear and polynomial
regression analysis, i, ii, iii. Proceedings of the Koninklijke
Nederlandse Akademie Wetenschappen, Series A - Mathematical
Sciences 53, 386-392, 521-525, 1397-1412.</p>
    <p>&#8230; see also several of the Air Quality Expert Group (AQEG) reports for
  the use of similar tests applied to UK/European air quality data, see
  <a href = 'http://uk-air.defra.gov.uk/library/aqeg/'>http://uk-air.defra.gov.uk/library/aqeg/</a>.</p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <p>See <code><a href='smoothTrend.html'>smoothTrend</a></code> for a flexible approach to
  estimating trends using nonparametric regression. The <code>smoothTrend</code>
  function is suitable for cases where trends are not monotonic and is
  probably better for exploring the shape of trends.</p>
    

    <h2 class="hasAnchor" id="examples">
      <a class="anchor" href="#examples"></a>
      Examples
    </h2>
    <pre class="examples"><div class='input'>

<span class='co'># load example data from package</span>
<span class='fu'>data</span>(<span class='no'>mydata</span>)

<span class='co'># trend plot for nox</span>
<span class='fu'>TheilSen</span>(<span class='no'>mydata</span>, <span class='kw'>pollutant</span> <span class='kw'>=</span> <span class='st'>"nox"</span>)</div><div class='output co'>#&gt; [1] &quot;Taking bootstrap samples. Please wait.&quot;
#&gt; </div><img src='TheilSen-3.png' alt='' width='540' height='400' /><div class='input'>
<span class='co'># trend plot for ozone with p=0.01 i.e. uncertainty in slope shown at</span>
<span class='co'># 99 % confidence interval</span>

<span class='co'>## Not run: TheilSen(mydata, pollutant = &amp;quot;o3&amp;quot;, ylab = &amp;quot;o3 (ppb)&amp;quot;, alpha = 0.01)</span>

<span class='co'># trend plot by each of 8 wind sectors</span>
<span class='co'>## Not run: TheilSen(mydata, pollutant = &amp;quot;o3&amp;quot;, type = &amp;quot;wd&amp;quot;, ylab = &amp;quot;o3 (ppb)&amp;quot;)</span>

<span class='co'># and for a subset of data (from year 2000 onwards)</span>
<span class='co'>## Not run: TheilSen(selectByDate(mydata, year = 2000:2005), pollutant = &amp;quot;o3&amp;quot;, ylab = &amp;quot;o3 (ppb)&amp;quot;)</span></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#details">Details</a></li>

      <li><a href="#references">References</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

    <h2>Author</h2>
    
David Carslaw with some trend code from Rand Wilcox

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by David Carslaw, Karl Ropkins.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
